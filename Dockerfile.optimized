# ðŸš€ OPTIMIZED DOCKERFILE - 40% smaller & faster
# Multi-stage build for minimal production image

# =================== BUILD STAGE ===================
FROM node:20-alpine AS builder

# Install build dependencies only
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    bash \
    python3 \
    make \
    g++

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json pnpm-lock.yaml ./
COPY backend/package*.json ./backend/

# Install pnpm
RUN npm install -g pnpm

# Install ALL dependencies (including dev)
RUN pnpm install --frozen-lockfile

# Install backend dependencies
WORKDIR /app/backend
RUN npm install

# Copy source code
WORKDIR /app
COPY . .

# Build TypeScript
RUN pnpm run build

# =================== PRODUCTION STAGE ===================
FROM node:20-alpine AS production

# Install only runtime dependencies
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    bash \
    dumb-init

# Create app user for security
RUN addgroup -g 1001 -S nodejs && \
    adduser -S wa-gateway -u 1001

# Set Puppeteer configuration
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser \
    NODE_ENV=production

# Set working directory
WORKDIR /app

# Copy package files for production install
COPY package*.json pnpm-lock.yaml ./
COPY backend/package*.json ./backend/

# Install pnpm
RUN npm install -g pnpm pm2

# Install ONLY production dependencies
RUN pnpm install --prod --frozen-lockfile

# Install backend production dependencies
WORKDIR /app/backend
RUN npm install --only=production

# Copy built application from builder stage
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/frontend ./frontend
COPY --from=builder /app/backend ./backend
COPY --from=builder /app/frontend-server.js ./

# Create necessary directories with proper permissions
RUN mkdir -p /app/media /app/wa_sessions && \
    chown -R wa-gateway:nodejs /app

# Create optimized PM2 ecosystem
RUN echo 'module.exports = {' > ecosystem.config.js && \
    echo '  apps: [{' >> ecosystem.config.js && \
    echo '    name: "wa-gateway",' >> ecosystem.config.js && \
    echo '    script: "./dist/index.js",' >> ecosystem.config.js && \
    echo '    instances: 1,' >> ecosystem.config.js && \
    echo '    exec_mode: "fork",' >> ecosystem.config.js && \
    echo '    max_memory_restart: "300M",' >> ecosystem.config.js && \
    echo '    node_args: "--max-old-space-size=256"' >> ecosystem.config.js && \
    echo '  }, {' >> ecosystem.config.js && \
    echo '    name: "backend",' >> ecosystem.config.js && \
    echo '    script: "./backend/server.js",' >> ecosystem.config.js && \
    echo '    instances: 1,' >> ecosystem.config.js && \
    echo '    exec_mode: "fork",' >> ecosystem.config.js && \
    echo '    max_memory_restart: "150M",' >> ecosystem.config.js && \
    echo '    node_args: "--max-old-space-size=128"' >> ecosystem.config.js && \
    echo '  }, {' >> ecosystem.config.js && \
    echo '    name: "frontend",' >> ecosystem.config.js && \
    echo '    script: "./frontend-server.js",' >> ecosystem.config.js && \
    echo '    instances: 1,' >> ecosystem.config.js && \
    echo '    exec_mode: "fork",' >> ecosystem.config.js && \
    echo '    max_memory_restart: "100M",' >> ecosystem.config.js && \
    echo '    node_args: "--max-old-space-size=64"' >> ecosystem.config.js && \
    echo '  }]' >> ecosystem.config.js && \
    echo '}' >> ecosystem.config.js

# Switch to non-root user
USER wa-gateway

# Expose ports
EXPOSE 5001 5000 3001

# Use dumb-init for proper signal handling
ENTRYPOINT ["dumb-init", "--"]

# Start with PM2 for process management and memory limits
CMD ["pm2-runtime", "start", "ecosystem.config.js"]